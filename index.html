<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cashier POS Pro</title>
  <style>
    :root {
      --primary-color: #009688;
      --primary-dark: #00796b;
      --background-color: #f0f2f5;
      --text-color: #333;
      --card-bg-color: #ffffff;
      --border-color: #e0e0e0;
      --shadow-color: rgba(0, 0, 0, 0.05);
      --danger-color: #e53935;
      --secondary-color: #555;
    }

    * { box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--background-color);
      margin: 0;
      height: 100vh;
      overflow: hidden; /* Prevent body scroll */
    }
    
    .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    header {
        background-color: var(--primary-dark);
        color: white;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h2 { margin: 0; font-size: 1.2rem; }
    #view-toggle-btn {
        padding: 0.5rem 1rem;
        border: 1px solid white;
        background-color: transparent;
        color: white;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    #view-toggle-btn:hover { background-color: rgba(255,255,255,0.1); }

    /* Main two-column layout for sales */
    .sales-view {
      display: grid;
      grid-template-columns: 3fr 2fr; /* 60% for products, 40% for cart */
      gap: 1rem;
      padding: 1rem;
      height: calc(100vh - 60px); /* Full height minus header */
      overflow: hidden;
    }

    #product-panel, #cart-panel {
        background: var(--card-bg-color);
        border-radius: 8px;
        box-shadow: 0 1px 3px var(--shadow-color);
        display: flex;
        flex-direction: column;
    }

    /* Product Panel (Left Side) */
    #product-search {
        width: calc(100% - 2rem);
        margin: 1rem;
        padding: 0.75rem;
    }
    #product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
        padding: 0 1rem 1rem 1rem;
        overflow-y: auto; /* Allow scrolling for products */
    }
    .product-btn {
        padding: 0.5rem;
        font-size: 0.9rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 80px;
    }
    .product-btn:hover { background-color: #f0fdfa; border-color: var(--primary-color); }
    .product-btn:active { transform: scale(0.96); }
    .product-name { font-weight: 600; }
    .product-price { color: var(--primary-dark); font-weight: bold; }

    /* Cart Panel (Right Side) */
    #cart-panel h3 { margin: 1rem; text-align: center; color: var(--primary-dark); }
    .cart-items { flex-grow: 1; overflow-y: auto; padding: 0 1rem; }
    #cartTable { width: 100%; border-collapse: collapse; }
    #cartTable th, #cartTable td { padding: 8px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    #cartTable th { font-size: 0.9rem; }
    .cart-summary {
        padding: 1rem;
        border-top: 2px solid var(--primary-color);
    }
    .total-line { display: flex; justify-content: space-between; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; }
    .total-line span:first-child { color: var(--primary-dark); }
    #payment-form input { padding: 0.75rem; }
    #payment-form button { background-color: var(--primary-color); color: white; padding: 1rem; font-size: 1.2rem; }
    #payment-form button:hover { background-color: var(--primary-dark); }

    /* Admin View Styling */
    .admin-view {
        padding: 1rem;
        max-width: 800px;
        margin: 0 auto;
        height: calc(100vh - 60px);
        overflow-y: auto;
    }
    .toggle-header { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; margin-top: 1rem; padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; font-weight: 600; }
    .toggle-content { display: none; padding: 1rem; border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; }
    
    #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; color: white; flex-direction: column; }
    .spinner { width: 60px; height: 60px; border: 8px solid #f3f3f3; border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Media Query for smaller screens */
    @media (max-width: 768px) {
        .sales-view {
            grid-template-columns: 1fr; /* Stack columns on mobile */
            height: auto;
            overflow-y: auto;
        }
        #product-panel { min-height: 50vh; }
        #cart-panel { min-height: 50vh; }
        header h2 { font-size: 1rem; }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <p>Processing...</p>
  </div>

  <div class="app-container">
    <header>
      <h2>SoftDrinks POS</h2>
      <button id="view-toggle-btn" onclick="toggleView()">Switch to Admin View</button>
    </header>

    <main id="sales-view" class="sales-view">
      <div id="product-panel">
        <input type="search" id="product-search" placeholder="üîç Search for a product..." onkeyup="renderProductGrid()">
        <div id="product-grid">
          </div>
      </div>

      <div id="cart-panel">
        <h3>Current Sale</h3>
        <div class="cart-items">
          <table id="cartTable">
            <thead>
              <tr><th>Item</th><th>Qty</th><th>Total</th><th>‚ùå</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="cart-summary">
          <div class="total-line">
            <span>TOTAL</span>
            <span id="cart-total">‚Ç±0.00</span>
          </div>
          <div id="payment-form">
            <input id="cash_received" type="number" placeholder="Cash Received">
            <button onclick="processSale()">Process Sale</button>
          </div>
        </div>
      </div>
    </main>

    <main id="admin-view" class="admin-view" style="display: none;">
      <div class="toggle-header" onclick="toggleSection('addProductSection')"><span>‚ûï Add New Product</span><span>‚ñº</span></div>
      <div id="addProductSection" class="toggle-content">
        <input id="add_name" placeholder="Product Name" />
        <input id="add_unit" placeholder="Unit (e.g. bottle, can)" />
        <input id="add_buy_price" type="number" placeholder="Buy Price (Cost per item)" />
        <input id="add_price" type="number" placeholder="Sell Price" />
        <input id="add_stock" type="number" placeholder="Stock Quantity" />
        <select id="add_paid">
          <option value="Paid">Paid</option>
          <option value="Not Paid">Not Paid</option>
        </select>
        <button onclick="addProduct()">Add Product & Record Expense</button>
      </div>

      <div class="toggle-header" onclick="toggleSection('salesHistorySection')"><span>üìÖ Sales History</span><span>‚ñº</span></div>
      <div id="salesHistorySection" class="toggle-content">
         <div class="receipt" id="receipt" style="display:none; margin-bottom: 1rem;">
          <div class="store-title">üßæ LLAVORE VARIETY STORE</div>
          <div id="receiptContent"></div>
          <button class="print-button" onclick="window.print()" style="background: var(--primary-dark); color: white;">üñ® Print Receipt</button>
        </div>
        <table id="salesTable">
          <thead>
            <tr><th>Transaction Details</th><th>Total</th><th>Time</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="toggle-header" onclick="toggleSection('expensesSection')"><span>üí∏ Expenses History</span><span>‚ñº</span></div>
      <div id="expensesSection" class="toggle-content">
        <table id="expensesTable">
          <thead>
            <tr><th>Description</th><th>Amount</th><th>Status</th><th>Time</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </main>

  </div>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbyol14uzmmDq3KNNVZqQ6WMMeisZrwCA_GdVcHCF5deeRer98ikDXvUy6dipJSM3ZbY/exec";
    let inventoryData = [];
    let cart = [];
    let syncQueue = JSON.parse(localStorage.getItem("syncQueue") || "[]");

    // --- View Management ---
    function toggleView() {
        const salesView = document.getElementById('sales-view');
        const adminView = document.getElementById('admin-view');
        const toggleBtn = document.getElementById('view-toggle-btn');
        
        if (salesView.style.display !== 'none') {
            salesView.style.display = 'none';
            adminView.style.display = 'block';
            toggleBtn.textContent = 'Switch to Sales View';
        } else {
            salesView.style.display = 'grid';
            adminView.style.display = 'none';
            toggleBtn.textContent = 'Switch to Admin View';
        }
    }
    
    // --- Utility & Setup Functions ---
    const showLoader = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; };
    const toggleSection = (id) => { const el = document.getElementById(id); el.style.display = el.style.display === 'block' ? 'none' : 'block'; };

    // --- Main Data Loading & Rendering ---
    async function initializeApp() {
        showLoader(true);
        try {
            await loadInventory();
            renderProductGrid(); // Initial render
            loadSalesHistory();
            if (navigator.onLine) {
                await Promise.all([loadSalesToday(), loadExpensesHistory(), syncOfflineData()]);
            }
        } catch (e) {
            console.error("Initialization failed:", e);
        } finally {
            showLoader(false);
        }
    }

    async function loadInventory() {
        const populateInventory = (data) => {
            inventoryData = data.slice(1);
        };

        if (!navigator.onLine) {
            const cachedData = localStorage.getItem('inventoryCache');
            if (cachedData) populateInventory(JSON.parse(cachedData));
            return;
        }

        try {
            const data = await fetchData('getInventory');
            localStorage.setItem('inventoryCache', JSON.stringify(data));
            populateInventory(data);
        } catch (e) {
            const cachedData = localStorage.getItem('inventoryCache');
            if (cachedData) populateInventory(JSON.parse(cachedData));
        }
    }
    
    // MODIFIED: Renders a grid of product buttons instead of a dropdown
    function renderProductGrid() {
        const grid = document.getElementById('product-grid');
        const searchTerm = document.getElementById('product-search').value.toLowerCase();
        grid.innerHTML = ''; // Clear existing grid

        const filteredInventory = inventoryData.filter(row => 
            row[0].toLowerCase().includes(searchTerm) && parseInt(row[2], 10) > 0
        );
        
        filteredInventory.forEach(row => {
            const name = row[0];
            const price = parseFloat(row[4]);
            const stock = row[2];

            const btn = document.createElement('div');
            btn.className = 'product-btn';
            btn.innerHTML = `<span class="product-name">${name}</span><span class="product-price">‚Ç±${price.toFixed(2)}</span>`;
            // Pass name and price directly
            btn.onclick = () => addToCart(name, price); 
            grid.appendChild(btn);
        });
    }

    async function fetchData(action) {
        if (!navigator.onLine) throw new Error("Offline");
        const res = await fetch(`${SHEET_URL}?action=${action}`);
        if (!res.ok) throw new Error(`Server Error: ${res.status}`);
        return res.json();
    }
    
    // --- Cart & Sale Logic ---
    // MODIFIED: Now accepts arguments directly
    function addToCart(name, price, qty = 1) {
        const item = inventoryData.find(p => p[0] === name);
        if (!item) return;

        const availableStock = parseInt(item[2], 10);
        const existingCartItem = cart.find(i => i.name === name);
        const qtyInCart = existingCartItem ? existingCartItem.qty : 0;

        if (qty + qtyInCart > availableStock) {
            alert(`Not enough stock for ${name}. Available: ${availableStock}`);
            return;
        }

        if (existingCartItem) {
            existingCartItem.qty += qty;
            existingCartItem.total = existingCartItem.qty * existingCartItem.price;
        } else {
            cart.push({ name, price, qty, total: qty * price });
        }
        updateCartUI();
    }

    function updateCartUI() {
        const tbody = document.querySelector("#cartTable tbody");
        tbody.innerHTML = cart.map((item, i) => `
            <tr>
                <td>${item.name}</td>
                <td>${item.qty}</td>
                <td>‚Ç±${item.total.toFixed(2)}</td>
                <td><button onclick="removeCart(${i})" style="background:none; border:none; cursor:pointer;">‚ùå</button></td>
            </tr>
        `).join("");
        
        const total = cart.reduce((sum, item) => sum + item.total, 0);
        document.getElementById('cart-total').textContent = `‚Ç±${total.toFixed(2)}`;
    }
    
    function removeCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    async function processSale() {
        if (cart.length === 0) return alert("Cart is empty!");
        const grandTotal = cart.reduce((sum, item) => sum + item.total, 0);
        const cashReceived = parseFloat(document.getElementById("cash_received").value);
        if (isNaN(cashReceived) || cashReceived < grandTotal) return alert("Cash received is not enough or invalid!");
        
        showLoader(true);
        
        const transactionId = `sale_${Date.now()}`;
        const timeISO = new Date().toISOString();

        try {
            const salePromises = cart.map(item => {
                const data = { action: "sell", product: item.name, quantity: item.qty, price: item.price, total: item.total, time: timeISO };
                return navigator.onLine ? fetch(SHEET_URL, { method: "POST", body: new URLSearchParams(data) }) : syncQueue.push(data);
            });
            await Promise.all(salePromises);

            saveTransactionToHistory({
                id: transactionId,
                items: [...cart],
                grandTotal,
                cashReceived,
                change: cashReceived - grandTotal,
                timestamp: timeISO
            });
            
            // Clear for next sale
            cart = [];
            updateCartUI();
            document.getElementById('cash_received').value = '';

            alert(`Sale successful! Change: ‚Ç±${(cashReceived - grandTotal).toFixed(2)}`);
            await loadInventory(); // Refresh inventory data
            renderProductGrid(); // Re-render grid to reflect stock changes
            loadSalesHistory(); // Refresh history view
            if (navigator.onLine) await loadSalesToday();

        } catch(error) {
            alert("An error occurred during the sale. Please try again.");
        } finally {
            showLoader(false);
        }
    }

    // --- Admin Panel Functions (History, Expenses, Add Product) ---
    function saveTransactionToHistory(transaction) {
        let history = JSON.parse(localStorage.getItem('salesTransactionHistory') || '[]');
        history.unshift(transaction);
        if (history.length > 100) history = history.slice(0, 100);
        localStorage.setItem('salesTransactionHistory', JSON.stringify(history));
    }
    
    function loadSalesHistory() {
        const history = JSON.parse(localStorage.getItem('salesTransactionHistory') || '[]');
        const tbody = document.querySelector("#salesTable tbody");
        tbody.innerHTML = history.length ? history.map(trans => `
            <tr>
                <td>${trans.items.map(item => `${item.qty}x ${item.name}`).join(', ')}</td>
                <td>‚Ç±${trans.grandTotal.toFixed(2)}</td>
                <td>${new Date(trans.timestamp).toLocaleString()}</td>
                <td><button onclick="reprintTransaction('${trans.id}')" class="btn-secondary">Reprint</button></td>
            </tr>
        `).join('') : `<tr><td colspan="4">No sales history found.</td></tr>`;
    }

    function reprintTransaction(transactionId) {
        const history = JSON.parse(localStorage.getItem('salesTransactionHistory') || '[]');
        const transaction = history.find(t => t.id === transactionId);
        if (!transaction) return alert("Transaction not found!");

        let receiptHTML = transaction.items.map(item => `<p>${item.name} x${item.qty} - ‚Ç±${item.total.toFixed(2)}</p>`).join('');
        receiptHTML += `<hr><p><strong>Total:</strong> ‚Ç±${transaction.grandTotal.toFixed(2)}</p>`;
        receiptHTML += `<p><strong>Cash:</strong> ‚Ç±${transaction.cashReceived.toFixed(2)}</p>`;
        receiptHTML += `<p><strong>Change:</strong> ‚Ç±${transaction.change.toFixed(2)}</p>`;
        receiptHTML += `<br><p><em>${new Date(transaction.timestamp).toLocaleString()}</em></p><p><em>(Reprinted)</em></p>`;

        document.getElementById("receiptContent").innerHTML = receiptHTML;
        const receiptEl = document.getElementById("receipt");
        receiptEl.style.display = "block";
        receiptEl.scrollIntoView({ behavior: 'smooth' });
    }
    
    async function loadSalesToday() {
        const data = await fetchData('todaySales');
        // This element doesn't exist in the new UI, but we keep the logic in case it's added back
    }

    async function loadExpensesHistory() {
        try {
            const data = await fetchData('getExpenses');
            const tbody = document.querySelector("#expensesTable tbody");
            tbody.innerHTML = data.slice(1).reverse().map(row => `<tr><td>${row[1]}</td><td>‚Ç±${parseFloat(row[2]).toFixed(2)}</td><td>${row[3]}</td><td>${new Date(row[0]).toLocaleString()}</td></tr>`).join('');
        } catch (e) {
            document.querySelector("#expensesTable tbody").innerHTML = `<tr><td colspan="4">Expense history is available online only.</td></tr>`;
        }
    }

    async function addProduct() {
      // ... (This function remains the same as your last version)
    }

    async function syncOfflineData() {
      // ... (This function remains the same as your last version)
    }

    // --- Initial Load ---
    window.onload = initializeApp;

  </script>
</body>
</html>
